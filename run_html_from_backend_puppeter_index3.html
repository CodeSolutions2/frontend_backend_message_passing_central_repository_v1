<!DOCTYPE html>
<html>
<head></head>
<body>

<button class="buttonClass" id="Generate_keys_crypto" type="button" style="display:none;"></button>
	
<!-- --------------------------------------------------- -->

<script type="module" src="./index.js"></script>

<!-- --------------------------------------------------- -->
	
<script>

// -----------------------------------------------

// Force the page to refresh the cached webpage
window.addEventListener('beforeunload', function() {
 	window.location.href = window.location.href + '?nocache=' + new Date().getTime();
});

// -----------------------------------------------

document.getElementById("Generate_keys_crypto").addEventListener("click", async () => {

	await Generate_keys_crypto()
		.then(async function() {
			// Step 3: Frontend = make the button [be found in the DOM or to be NOT hidden] to make the Backend detect that the Frontend is finished
			 await setTimeout(function() { document.getElementById("Generate_keys_crypto").style.display = 'block'; }, 300);
		})
		.then(function() {
			// Step 4: Frontend = continue to ensure that the button non-visible (style="display:none;")
			document.getElementById("Generate_keys_crypto").style.display = 'none';
		})
	
});

// ----------------------------------------------------



async function add_data_to_file() {
	
	var RepoAobj = {};
	RepoAobj.repoOwner = 'CodeSolutions2';
	RepoAobj.repoA_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.repoB_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.type_of_encryption = "window_crypto_subtle";
	RepoAobj.append_text == "do_not_append_save_existing_textOnly"
	RepoAobj.NEW_publicKey_jwk = publicKey_jwk;
	RepoAobj.pubpriv_keys_for_encryption = 'new';

	RepoAobj.filename = filepath_arr.pop(); // filename to create in RepoB, in foldername
	RepoAobj.foldername = filepath_arr.join(''); // foldername in RepoB
	
	// Assign the class where input_text is the generated privateKey_jwk
	const classObj2 = new encrypted_CRUD_file_storage(RepoAobj);
	
	// GET encrypted file data w/[key from file], decrypt file data w/[key from file], use the new
	await classObj2.add_data_to_file();

}


	
// ----------------------------------------------------
// Key Generation with respect to encrypted_CRUD_files
// ----------------------------------------------------
async function Generate_keys_crypto() {
	
	// STEP 0: Generate public and private keys (public key=for encrypting, private key=for decrypting)
	var keyPair_obj = await window.crypto.subtle.generateKey({name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([0x01, 0x00, 0x01]), hash: {name: "SHA-256"}}, true, ["encrypt", "decrypt"]);
	
	// STEP 1: Obtain RSA key pair as individual objects - https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/generateKey
	// STEP 2: Convert public key and private key into a JSON string (JsonWebKey)
	
	// Generate a new publicKey_jwk_str
   	var publicKey_jwk = await window.crypto.subtle.exportKey("jwk", keyPair_obj.publicKey);
	
	// Generate a new privateKey_jwk
	var privateKey_jwk = await window.crypto.subtle.exportKey("jwk", keyPair_obj.privateKey);
	
	// -----------------------------

	// GET the list of files that are encrypted, to re-encrypt them with the new key
	var filepaths_to_encrypt = await GET_repo_file_info_RESTAPI_fast();
  console.log('filepaths_to_encrypt: ', filepaths_to_encrypt);
  
	var filepaths_to_encrypt_arr = filepaths_to_encrypt.split('\n');
  console.log('filepaths_to_encrypt_arr: ', filepaths_to_encrypt_arr);
	
	// -----------------------------

	var RepoAobj = {};
	RepoAobj.repoOwner = 'CodeSolutions2';
	RepoAobj.repoA_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.repoB_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.type_of_encryption = "window_crypto_subtle";
	RepoAobj.append_text == "do_not_append_save_existing_textOnly"
	RepoAobj.NEW_publicKey_jwk = publicKey_jwk;
	RepoAobj.pubpriv_keys_for_encryption = 'new';
	
	var done = filepaths_to_encrypt_arr.map((filepath_to_encrypt, index) => {

		var filepath_arr = filepath_to_encrypt.split("/");
		RepoAobj.filename = filepath_arr.pop(); // filename to create in RepoB, in foldername
		RepoAobj.foldername = filepath_arr.join(''); // foldername in RepoB
		
		// Assign the class where input_text is the generated privateKey_jwk
		const classObj2 = new encrypted_CRUD_file_storage(RepoAobj);
		
		// GET encrypted file data w/[key from file], decrypt file data w/[key from file], use the new
		await classObj2.add_data_to_file();

		return 'ok';
	});

	// -----------------------------

	// Save keys to file
	await Save_to_file_keys_crypto();

	// -----------------------------
}

// ----------------------------------------------------

async function GET_repo_file_info_RESTAPI_fast() {
	return await fetch(`https://raw.githubusercontent.com/CodeSolutions2/frontend_backend_message_passing_central_repository_v1/main/.github/encrypt_list`)
		.then(res => res.text())
		.then(async function (text_out) { return  text_out; })
		.catch(error => { console.log(error); });
}

// ----------------------------------------------------
	
async function Save_to_file_keys_crypto() {

	var RepoAobj = {};
	RepoAobj.repoOwner = 'CodeSolutions2';
	RepoAobj.repoA_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.foldername = '.github'; // foldername in RepoB
	RepoAobj.repoB_name = 'frontend_backend_message_passing_central_repository_v1';
	RepoAobj.type_of_encryption = "salt_scramble";

	// -----------------------------
	
	RepoAobj.input_text = JSON.stringify(publicKey_jwk);
	
	// Assign the class where input_text is the generated publicKey_jwk_str
	const classObj0 = new encrypted_CRUD_file_storage(RepoAobj);
   
	// Encrypt the publicKey_jwk_str
	RepoAobj.input_text = await classObj0.encrypt_text_string()
	// console.log("encrypted_publicKey_jwk_str: ", RepoAobj.input_text.slice(0,5));
	
	// Save the encrypted string to the .public_window_crypto_subtle
	RepoAobj.filename = '.public_window_crypto_subtle'; // filename to create in RepoB, in foldername
	await run_backend_process(RepoAobj);
   
	// -----------------------------

	RepoAobj.input_text = JSON.stringify(privateKey_jwk);
	
	// Assign the class where input_text is the generated privateKey_jwk
	const classObj1 = new encrypted_CRUD_file_storage(RepoAobj);

	// Encrypt the privateKey_jwk_str
	RepoAobj.input_text = await classObj1.encrypt_text_string();
	// console.log("encrypted_privateKey_jwk_str: ", RepoAobj.input_text.slice(0,5));

	// Save the encrypted string to the .private_window_crypto_subtle
	RepoAobj.filename = '.private_window_crypto_subtle'; // filename to create in RepoB, in foldername
	await run_backend_process(RepoAobj);
	
	// -----------------------------
}

// ----------------------------------------------------


// ----------------------------------------------------


// ----------------------------------------------------

	
</script>
</body>
</html>
